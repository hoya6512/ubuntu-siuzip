{% extends "blog/base.html" %}
{% load blog_filter %}

{% block content %}

    <div class="container-xl my-3">
      <ul class="shadow list-group">
        <li class="list-group-item shadow-sm p-3">
          <div
            class="row align-items-center p-2 mx-0 mb-2 rounded shadow-sm"
            style="background-color: #8b9dc3"
          >
            <div class="col-md-10">
              <h2 style="font-weight: 900; color: white">{{ post.title }}</h2>
            </div>
            <div class="col-md-2 text-end">
                <span class="category py-1 px-2 rounded-pill">{{ post.category }}</span>

            </div>
          </div>
          <div
            class="row d-flex p-2 mb-2 mx-0 rounded shadow-sm"
            style="background-color: #dfe3ee"
          >
            <div class="col-6 py-2">
               <span class="ms-auto p-2" style="font-weight: 600">
                  <img
                    class="img-fluid rounded-circle me-2"
                        {% if post.author.profile.avatar %}
                            src="{{ post.author.profile.avatar.url }}"
                        {% else %}
                            src="/media/guest_avatar(32px).png"
                        {% endif %}
                    style="width: 1em; height: 1em"
                    alt="{{ post.author.nick_name }}'s avatar"/>
                  {{ post.author.nick_name }}
              </span>
            </div>
            <div class="col-6 text-md-end py-2">

              <span class="ms-auto" style="font-weight: 600"
                >{{ post.created_at|timesince }} 전</span
              >

            </div>
          </div>

{#        블로그 내용#}
          <div
            class="p-3 mb-2 text-emphasis-secondary rounded shadow-sm"
            style="background-color: #f7f7f7"
          >
            {{ post.content|mark }}
          </div>

          <div class="d-flex">
                <div class="btn-group align-items-center w-75" role="group">
                  <button
                    class="btn btn-outline-primary shadow-sm"
                    style="font-weight: 600"
                    role="button"
                    onclick="location.href='{% url "blog:post_edit" post.pk %}'"
                    {% if request.user != post.author %}
                        disabled
                    {% endif %}
                  >
                  <i class="fa-solid fa-pen"></i> 수정
                  </button>

                  <button
                    class="post-delete btn btn-outline-secondary shadow-sm"
                    style="font-weight: 600"
                    href="javascript:void(0)"
                    data-uri="{% url "blog:post_delete" post.pk %}"
                    {% if request.user != post.author %}
                        disabled
                    {% endif %}
                  ><i class="fa-solid fa-trash"></i> 삭제
                  </button>
                </div>

                <div class="ms-auto py-2">
                  <a
                    role="button"
                    class="btn btn-outline-danger"
                    href="{% url "blog:post_like" post.pk %}"
                    style="font-weight: 600"
                  >
                      {% if request.user in post.like_users.all %}
                      <i class="fa-solid fa-heart" style="color:red"></i>
                      {{ post.like_users.count }}
                      {% else %}
                      <i class="fa-regular fa-heart" style="color:red"></i>
                      {{ post.like_users.count }}
                      {% endif %}
                  </a>
                </div>
          </div>
        </li>
      </ul>
    </div>
    <div class="container-xl btn-group mb-3">
        {% if previous_post %}
            <a
                role="button"
                class="btn btn-outline-dark w-25 align-content-center"
                href="{% url 'blog:post_detail' previous_post.pk %}"
            >◀ 이전글<br>
            "{{ previous_post.title }}"</a>
        {% else %}
            <button
                role="button"
                class="btn btn-outline-dark w-25 align-content-center"
                href="#"
                disabled=""
            >◀ 이전글<br></button>
        {% endif %}
            <a
                role="button"
                class="btn btn-outline-dark w-25 align-content-center"
                href="{% url "blog:index" %}"
            >목록으로</a>

        {% if next_post %}
            <a
                role="button"
                class="btn btn-outline-dark w-25 align-content-center"
                href="{% url 'blog:post_detail' next_post.pk %}"
            >다음글 ▶<br>
            "{{ next_post.title }}"</a>
        {% else %}
            <button
                role="button"
                class="btn btn-outline-dark w-25 align-content-center"
                href="#"
                disabled=""
            >다음글 ▶<br></button>
        {% endif %}
    </div>
    <!-- 댓글 표시창 구현 -->
    <div class="container-xl">
        <p class="shadow-sm border rounded border-1 p-3"><i class="fa-regular fa-comment"></i> 댓글 {{ post.comment_set.count }} 개</p>
      <ul class="shadow list-group mb-5">
        {% if post.comment_set.count == 0 %}
            <h4 class="text-center">댓글이 없습니다.</h4>
        {% else %}

        {% for comment in post.comment_set.all %}
        <li class="list-group-item p-0">
          <div class="row p-3 mb-2 text-emphasis-secondary">
            <span class="anchor" id="comment{{ comment.pk }}"></span>
            <!-- 댓글 작성자 -->
            <div class="comment-writer col-md-10">
              <img
                class="img-fluid rounded-circle me-2"
                    {% if comment.author.profile.avatar %}
                        src="{{ comment.author.profile.avatar.url }}"
                    {% else %}
                        src="/media/guest_avatar(32px).png"
                    {% endif %}
                style="width: 25px; height: 25px"
                alt="{{ comment.author.nick_name }}'s avatar"/>
                <span>{{ comment.author.nick_name }}</span>
                {% if comment.author == post.author %}
                    <span class="badge rounded-pill text-bg-primary align-text-bottom" style="font-size: x-small">작성자</span>
                {% endif %}
                <span class="text-secondary" style="font-size: small">{{ comment.updated_at|timesince }} 전</span>

                <a
                    role="button"
                    class="btn btn-outline-danger ms-2 p-1"
                    href="{% url "blog:comment_like" comment.pk %}"
                    style="font-size: small"
                >
                      {% if request.user in comment.like_users.all %}
                      <i class="fa-solid fa-heart" style="color:red"></i>
                      {{ comment.like_users.count }}
                      {% else %}
                      <i class="fa-regular fa-heart" style="color:red"></i>
                      {{ comment.like_users.count }}
                      {% endif %}
                </a>

                <div
                class="replyContent my-3"
              >{{ comment.content }}</div>
            </div>

            <div class="col-md-2">
              <div class="btn-group align-items-center w-100" role="group">
                <button
                  class="btn btn-outline-primary shadow-sm"
                  style="font-weight: 600"
                  role="button"
                  onclick="location.href='{% url "blog:comment_edit" comment.pk %}'"
                  {% if request.user != comment.author %}
                    disabled
                  {% endif %}
                >
                  <i class="fa-solid fa-pen"></i> 수정
                </button>
                <button
                  class="comment-delete btn btn-outline-secondary shadow-sm"
                  style="font-weight: 600"
                  href="javascript:void(0)"
                  data-uri="{% url "blog:comment_delete" comment.pk %}"
                  {% if request.user != comment.author %}
                    disabled
                  {% endif %}
                >
                  <i class="fa-solid fa-trash"></i> 삭제
                </button>
              </div>
                <button class="btn btn-outline-dark shadow-sm w-100"
                        onclick="location.href='{% url "blog:reply_new" comment.pk %}'"
                        {% if not user.is_authenticated %}
                            disabled
                        {% endif %}
                  style="font-weight: 600"><i class="fa-solid fa-comment"></i> 댓글</button>

            </div>
          </div>
        </li>
{#            대댓글 표시#}
            {% for reply in comment.reply_set.all %}
                <li class="list-group-item p-0 bg-body-tertiary">
                  <div class="row p-3 mb-2">
                    <span class="anchor" id="reply{{ reply.pk }}"></span>
                    <!-- 댓글 작성자 -->
                    <div class="col-1 col-md-1 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-return-right" viewBox="0 0 16 16">
                          <path fill-rule="evenodd" d="M1.5 1.5A.5.5 0 0 0 1 2v4.8a2.5 2.5 0 0 0 2.5 2.5h9.793l-3.347 3.346a.5.5 0 0 0 .708.708l4.2-4.2a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 8.3H3.5A1.5 1.5 0 0 1 2 6.8V2a.5.5 0 0 0-.5-.5"/>
                        </svg>
                    </div>

                    <div class="comment-writer col-11 col-md-9">
                      <img
                        class="img-fluid rounded-circle me-2"
                            {% if reply.author.profile.avatar %}
                                src="{{ reply.author.profile.avatar.url }}"
                            {% else %}
                                src="/media/guest_avatar(32px).png"
                            {% endif %}
                        style="width: 25px; height: 25px"
                        alt="{{ reply.author.nick_name }}'s avatar"/>
                        <span>{{ reply.author.nick_name }}</span>
                        {% if reply.author == post.author %}
                            <span class="badge rounded-pill text-bg-primary align-text-bottom" style="font-size: x-small">작성자</span>
                        {% endif %}
                        <span class="text-secondary" style="font-size: small">{{ reply.updated_at|timesince }} 전</span>

                        <a
                            role="button"
                            class="btn btn-outline-danger ms-2 p-1"
                            href="{% url "blog:reply_like" reply.pk %}"
                            style="font-size: small"
                        >
                              {% if request.user in reply.like_users.all %}
                              <i class="fa-solid fa-heart" style="color:red"></i>
                              {{ reply.like_users.count }}
                              {% else %}
                              <i class="fa-regular fa-heart" style="color:red"></i>
                              {{ reply.like_users.count }}
                              {% endif %}
                        </a>

                        <div class="replyContent my-3">
                              {{ reply.content }}
                        </div>
                    </div>



                    <div class="col-md-2">
                      <div class="btn-group align-items-center w-100" role="group">
                        <button
                          class="btn btn-outline-primary shadow-sm"
                          style="font-weight: 600"
                          role="button"
                          onclick="location.href='{% url "blog:reply_edit" reply.pk %}'"
                          {% if request.user != reply.author %}
                            disabled
                          {% endif %}
                        >
                          <i class="fa-solid fa-pen"></i> 수정
                        </button>
                        <button
                          class="comment-delete btn btn-outline-secondary shadow-sm"
                          style="font-weight: 600"
                          href="javascript:void(0)"
                          data-uri="{% url "blog:reply_delete" reply.pk %}"
                          {% if request.user != reply.author %}
                            disabled
                          {% endif %}
                        >
                          <i class="fa-solid fa-trash"></i> 삭제
                        </button>
                      </div>

                    </div>
                  </div>
                </li>
            {% endfor %}
          {% endfor %}
      {% endif %}

      </ul>

    </div>

    <!-- 댓글 입력창 구현 -->
    <div class="container-xl">
        {% include "blog/comment_form.html"%}
    </div>




    <style>
      .title-name h1 {
        text-align: center;

        text-transform: uppercase;
        font-size: 26px;
        letter-spacing: 1px;

        display: grid;
        grid-template-columns: 1fr auto 1fr;
        grid-template-rows: 16px 0;
        grid-gap: 22px;

        font-weight: 300;
        font-size: 30px;
        color: #080808;
      }

      .title-name h1:after,
      .title-name h1:before {
        content: " ";
        display: block;
        border-bottom: 2px solid #ccc;
        background-color: #f8f8f8;
      }

      .category {
        border: thin solid #8b9dc3;
        background-color: #dfe3ee;
        color: #3b5998;
        font-weight: 600;
      }

      /* p {
        position: relative;
        padding-bottom: 56.25%;
        padding-top: 30px;
        height: 0;
        overflow: hidden;
      } */
      p iframe,
      p object,
      p embed {
        /* position: absolute; */
        /* top: 0;
        left: 0; */
        width: 100%;
        /* height: 100%; */
      }

      {#@media screen and (max-width: 738px) {#}
      {#  .comment-writer {#}
      {#    display: flex;#}
      {#    flex-direction: column;#}
      {#    align-items: center;#}
      {#  }#}
      {#}#}
    </style>
{% endblock %}

{% block script %}
<script type='text/javascript'>
const delete_post_elements = document.getElementsByClassName("post-delete");
Array.from(delete_post_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if(confirm("정말로 포스팅을 삭제하시겠습니까?")) {
            location.href = this.dataset.uri;
        };
    });
});

const delete_comment_elements = document.getElementsByClassName("comment-delete");
Array.from(delete_comment_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if(confirm("정말로 댓글을 삭제하시겠습니까?")) {
            location.href = this.dataset.uri;
        };
    });
});


function EmptyCheck(){
    let comment = document.getElementById('comment');
    let comment_val = comment.value;

    if(comment_val===''){
        alert('댓글을 입력해주세요.');
        comment.focus();
        return false;
    }

    return true;
}


</script>
{% endblock %}